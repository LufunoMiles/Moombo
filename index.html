<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#5b9279" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cattle AI Monitor</title>
<!-- RemixIcon CDN -->
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<style>
  /* ---------- Mobile-first base styles with clean white theme ---------- */
  :root {
    /* Clean white theme with green accents */
    --bg-light: #ffffff;
    --bg-lighter: #f8f9fa;
    --card-bg: #ffffff;
    --accent: rgb(194, 122, 71);
    --accent-hover: rgb(154, 88, 40);
    --accent-light: rgb(194, 122, 71);
    --muted: #6c757d;
    --muted-darker: #495057;
    --text-primary: #212529;
    --text-secondary: #495057;
    --good: #28a745;
    --warn: #ffc107;
    --danger: #dc3545;
    --glass: rgba(0,0,0,0.04);
    --border: #e9ecef;
    --shadow: rgba(0, 0, 0, 0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  /* Clean white background */
  html, body {
    height: 100%;
    background: var(--bg-light);
    color: var(--text-primary);
    overflow-x: hidden;
  }
  
  /* Splash screen */
  #splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }
  
  .splash-logo {
    width: 80px;
    height: 80px;
    background-color: var(--accent);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    font-size: 2.5rem;
    color: white;
    box-shadow: 0 8px 24px var(--shadow);
  }
  
  .splash-text {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .splash-subtext {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  /* Auth screens */
  #auth-screen {
    min-height: 100vh;
    padding: 40px 24px 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    max-width: 400px;
    margin: 0 auto;
  }
  
  .auth-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  
  .auth-logo {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    font-size: 2rem;
    color: white;
  }
  
  .auth-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .auth-subtitle {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .auth-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 16px var(--shadow);
    margin-bottom: 16px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .form-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 1rem;
    transition: all 0.2s ease;
  }
  
  .form-input:focus {
    outline: none;
    border-color: var(--accent);
    background: white;
    box-shadow: 0 0 0 3px rgba(91, 146, 121, 0.1);
  }
  
  .form-input.with-icon {
    padding-left: 44px;
  }
  
  .input-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted-darker);
    font-size: 1.1rem;
  }
  
  .input-wrapper {
    position: relative;
  }
  
  .auth-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .auth-link:hover {
    text-decoration: underline;
  }
  
  /* Main app container - hidden by default */
  .app {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .app-loaded {
    opacity: 1;
  }
  
  .app-header {
    padding: 16px 16px 0;
    background: var(--bg-light);
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 1px solid var(--border);
  }
  
  .app-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  h1 {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text-primary);
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .header-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 1.2rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .header-btn:hover {
    background: var(--bg-lighter);
    color: var(--accent);
  }
  
  .header-btn.logout {
    color: var(--danger);
  }
  
  .header-btn.logout:hover {
    background: rgba(220, 53, 69, 0.1);
  }
  
  /* Main content area */
  .app-main {
    flex: 1;
    padding: 16px 16px 20px;
  }
  
  /* Clean card design with subtle shadows */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px var(--shadow);
    margin-bottom: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    box-shadow: 0 4px 12px var(--shadow);
  }
  
  /* Primary button with accent color */
  .big-btn {
    display: block;
    width: 100%;
    padding: 16px 20px;
    border-radius: 12px;
    background: var(--accent);
    border: 0;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  .big-btn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(91, 146, 121, 0.25);
  }
  
  .big-btn:active {
    transform: translateY(0);
  }
  
  /* Scan button at the top */
  .scan-top-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white;
    padding: 18px;
    margin-bottom: 20px;
    font-size: 1.05rem;
  }
  
  .scan-top-btn i {
    font-size: 1.3rem;
  }
  
  /* Enhanced stats cards */
  .stats {
    display: flex;
    gap: 10px;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  
  .stat {
    flex: 1;
    padding: 16px 12px;
    border-radius: 12px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    text-align: center;
    transition: all 0.2s ease;
  }
  
  .stat:hover {
    background: white;
    border-color: var(--accent-light);
  }
  
  /* Improved animal cards with hover effect */
  .animal-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 16px;
    border-radius: 12px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .animal-card:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
    border-color: var(--accent-light);
  }
  
  /* Avatar design with icon background */
  .avatar {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.5rem;
    flex-shrink: 0;
    color: white;
  }
  
  .avatar i {
    font-size: 2rem;
  }
  
  .muted {
    color: var(--muted);
    font-size: 0.875rem;
  }
  
  .status-healthy {
    color: var(--good);
    font-weight: 600;
  }
  
  .status-warn {
    color: var(--warn);
    font-weight: 600;
  }
  
  .status-critical {
    color: var(--danger);
    font-weight: 600;
  }
  
  /* Enhanced alert rows */
  .alert-row {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 14px;
    border-radius: 10px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    margin-bottom: 8px;
    transition: all 0.2s ease;
  }
  
  .alert-row:hover {
    background: white;
    border-color: var(--accent-light);
  }
  
  .small {
    font-size: 0.8rem;
  }
  
  /* Footer navigation */
  .app-footer {
    padding: 12px 0;
    display: flex;
    gap: 8px;
    justify-content: space-around;
    position: sticky;
    bottom: 0;
    background: var(--bg-light);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }
  
  .nav-btn {
    background: transparent;
    border: 0;
    color: var(--muted-darker);
    font-weight: 600;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  
  .nav-btn:hover {
    color: var(--accent);
    background: var(--bg-lighter);
  }
  
  .nav-btn.active {
    color: var(--accent);
    background: rgba(91, 146, 121, 0.1);
  }
  
  .nav-icon {
    font-size: 1.2rem;
  }
  
  .nav-label {
    font-size: 0.7rem;
  }
  
  /* Views */
  .view {
    display: none;
  }
  
  .view.active {
    display: block;
  }
  
  /* Modal design */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 30;
    padding: 16px;
  }
  
  .modal {
    width: 100%;
    max-width: 420px;
    border-radius: 16px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    animation: modalSlideIn 0.3s ease;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .center {
    text-align: center;
  }
  
  input[type=file] {
    display: none;
  }
  
  /* Better progress bar */
  .progress {
    height: 8px;
    background: var(--bg-lighter);
    border-radius: 999px;
    overflow: hidden;
    margin-top: 16px;
    margin-bottom: 8px;
  }
  
  .progress > i {
    display: block;
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    transition: width 0.1s linear;
    border-radius: 999px;
  }
  
  /* Enhanced section headers */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .section-title {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-primary);
  }
  
  /* Video styling in camera modal */
  #camera-video {
    border-radius: 12px;
    background: #000;
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    margin-bottom: 16px;
  }
  
  /* Camera preview image */
  #camera-preview {
    border-radius: 12px;
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    margin-bottom: 16px;
    display: none;
  }
  
  /* Simple utility classes */
  .mb8 {
    margin-bottom: 8px;
  }
  
  .mt8 {
    margin-top: 10px;
  }
  
  .text-xs {
    font-size: 0.75rem;
  }
  
  /* Ghost button */
  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 10px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-ghost:hover {
    background: var(--bg-lighter);
    border-color: var(--muted);
    color: var(--text-primary);
  }
  
  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
    position: relative;
  }
  
  .divider-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    padding: 0 12px;
    color: var(--muted);
    font-size: 0.8rem;
  }
  
  /* Profile page styles */
  .profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .profile-stats {
    display: flex;
    gap: 16px;
    justify-content: space-between;
    padding: 20px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    margin: 20px 0;
  }
  
  /* Desktop tweaks */
  @media(min-width: 800px) {
    .app {
      max-width: 500px;
    }
    
    .app-header {
      padding: 20px 24px 0;
    }
    
    .app-main {
      padding: 20px 24px 20px;
    }
    
    h1 {
      font-size: 1.5rem;
    }
    
    .card {
      padding: 24px;
    }
  }
  
  /* Hide elements utility */
  .hidden {
    display: none !important;
  }
  
  /* Camera action buttons */
  .camera-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  
  .camera-actions .btn-ghost {
    flex: 1;
  }
  
  .camera-actions .big-btn {
    flex: 2;
    margin: 0;
  }
  
  /* Loading indicator */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top: 2px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Scan Results Modal Styles */
  .scan-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  
  .scan-results-title {
    font-weight: 700;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .scan-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .scan-result-item:last-child {
    border-bottom: none;
  }
  
  .scan-result-label {
    color: var(--muted);
    font-weight: 500;
  }
  
  .scan-result-value {
    font-weight: 600;
    text-align: right;
  }
  
  .scan-result-good {
    color: var(--good);
  }
  
  .scan-result-warning {
    color: var(--warn);
  }
  
  .scan-result-danger {
    color: var(--danger);
  }
  
  .scan-result-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .scan-result-actions .btn-ghost {
    flex: 1;
  }
  
  .scan-result-actions .big-btn {
    flex: 2;
    margin: 0;
  }
  
  /* Status indicator */
  .status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .status-indicator.good {
    background: rgba(40, 167, 69, 0.1);
    color: var(--good);
  }
  
  .status-indicator.warning {
    background: rgba(255, 193, 7, 0.1);
    color: var(--warn);
  }
  
  .status-indicator.danger {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger);
  }
  
  /* Animal match section */
  .animal-match {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--bg-lighter);
    border-radius: 12px;
    margin: 16px 0;
    border: 1px solid var(--border);
  }
  
  .animal-match-info {
    flex: 1;
  }
  
  .animal-match-name {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 4px;
  }
  
  .match-confidence {
    font-size: 0.85rem;
    color: var(--muted);
  }
  
  /* Toast notification */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: var(--text-primary);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
    font-weight: 500;
  }
  
  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--good);
  }
  
  .toast.error {
    background: var(--danger);
  }
  
  .toast.warning {
    background: var(--warn);
  }
</style>
</head>
<body>
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Splash Screen -->
  <div id="splash-screen">
    <div class="splash-logo">
      <img src="/cow.png" width="40" alt="">
    </div>
    <div class="splash-text">M<span style="color: chocolate;">oo</span>mbo</div>
    <div class="splash-subtext">Intelligent Livestock Management</div>
  </div>

  <!-- Auth Screens -->
  <div id="auth-screen" class="hidden">
    <!-- Login View -->
    <div id="auth-login" class="auth-view">
      <div class="auth-header">
        <div class="auth-logo">
          <img src="/cow.png" width="40" alt="">
        </div>
        <div class="auth-title">Welcome Back</div>
        <div class="auth-subtitle">Sign in to monitor your cattle</div>
      </div>
      
      <div class="auth-card">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <div class="input-wrapper">
            <i class="ri-mail-line input-icon"></i>
            <input type="email" class="form-input with-icon" id="login-email" placeholder="farmer@example.com">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Password</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input type="password" class="form-input with-icon" id="login-password" placeholder="Enter your password">
          </div>
        </div>
        
        <button class="big-btn" id="btn-login">
          <i class="ri-login-box-line"></i> Sign In
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <button class="big-btn" id="btn-google-login" style="background: #4285F4;">
          <i class="ri-google-fill"></i> Continue with Google
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <div class="center">
          <button class="btn-ghost" id="btn-go-to-signup">
            <i class="ri-user-add-line"></i> Create New Account
          </button>
        </div>
      </div>
      
      <div class="center">
        <a href="#" class="auth-link" id="btn-forgot-password">
          <i class="ri-key-line"></i> Forgot Password?
        </a>
      </div>
    </div>
    
    <!-- Signup View -->
    <div id="auth-signup" class="auth-view hidden">
      <div class="auth-header">
        <div class="auth-logo">
          <img src="/cow.png" width="40" alt="">
        </div>
        <div class="auth-title">Create Account</div>
        <div class="auth-subtitle">Start monitoring your cattle</div>
      </div>
      
      <div class="auth-card">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <div class="input-wrapper">
            <i class="ri-user-line input-icon"></i>
            <input type="text" class="form-input with-icon" id="signup-name" placeholder="John Farmer">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <div class="input-wrapper">
            <i class="ri-mail-line input-icon"></i>
            <input type="email" class="form-input with-icon" id="signup-email" placeholder="farmer@example.com">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Password</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input type="password" class="form-input with-icon" id="signup-password" placeholder="Create a strong password (min. 6 chars)">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Confirm Password</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input type="password" class="form-input with-icon" id="signup-confirm" placeholder="Confirm your password">
          </div>
        </div>
        
        <button class="big-btn" id="btn-signup">
          <i class="ri-user-add-line"></i> Create Account
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <button class="big-btn" id="btn-google-signup" style="background: #4285F4;">
          <i class="ri-google-fill"></i> Continue with Google
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <div class="center">
          <button class="btn-ghost" id="btn-go-to-login">
            <i class="ri-login-box-line"></i> Already have an account?
          </button>
        </div>
      </div>
    </div>
    
    <!-- Forgot Password View -->
    <div id="auth-forgot" class="auth-view hidden">
      <div class="auth-header">
        <div class="auth-logo">
          <i class="ri-cow-line"></i>
        </div>
        <div class="auth-title">Reset Password</div>
        <div class="auth-subtitle">We'll send you a reset link</div>
      </div>
      
      <div class="auth-card">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <div class="input-wrapper">
            <i class="ri-mail-line input-icon"></i>
            <input type="email" class="form-input with-icon" id="forgot-email" placeholder="Enter your email">
          </div>
        </div>
        
        <button class="big-btn" id="btn-send-reset">
          <i class="ri-mail-send-line"></i> Send Reset Link
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <div class="center">
          <button class="btn-ghost" id="btn-go-to-login-from-forgot">
            <i class="ri-arrow-left-line"></i> Back to Login
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (initially hidden) -->
  <div class="app hidden" id="app">
    <!-- App Header -->
    <header class="app-header">
      <div class="app-header-content">
        <div>
          <h1>M<span style="color: chocolate;">oo</span>mbo</h1>
          
        </div>
        <div class="header-actions">
          <button class="header-btn" id="btn-profile" title="Profile">
            <i class="ri-user-line"></i>
          </button>
          <button class="header-btn logout" id="btn-logout" title="Logout">
            <i class="ri-logout-box-r-line"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="app-main">
      <!-- DASHBOARD VIEW -->
      <div id="view-dashboard" class="view active">
        <!-- Scan Button at Top -->
        <button class="big-btn scan-top-btn" id="btn-scan-top">
          <i class="ri-camera-3-line"></i> Scan 
        </button>

        <section class="card">
          <div class="stats">
            <div class="stat">
              <div class="muted small">
                <i class="ri-cow-line"></i> Total Cattle
              </div>
              <div id="stat-animals" style="font-weight:700;font-size:1.4rem;margin-top:6px;color:var(--text-primary)">--</div>
            </div>
            <div class="stat">
              <div class="muted small">
                <i class="ri-heart-line"></i> Healthy
              </div>
              <div id="stat-healthy" style="font-weight:700;font-size:1.4rem;margin-top:6px;color:var(--good)">--</div>
            </div>
            <div class="stat">
              <div class="muted small">
                <i class="ri-alert-line"></i> Needs Attention
              </div>
              <div id="stat-sick" style="font-weight:700;font-size:1.4rem;margin-top:6px;color:var(--warn)">--</div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-alarm-warning-line"></i> Recent Alerts
            </div>
            <button class="btn-ghost" id="btn-open-alerts">
              <i class="ri-eye-line"></i> View all
            </button>
          </div>
          <div id="alerts-list"></div>
        </section>

        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-cow-line"></i> Your Cattle
            </div>
            <div class="muted small">Tap to view details</div>
          </div>
          <div id="animals-list"></div>
        </section>
      </div>

      <!-- ANIMAL PROFILE VIEW -->
      <div id="view-profile" class="view">
        <section class="card">
          <div class="profile-header">
            <div>
              <div id="profile-name" style="font-weight:700;font-size:1.3rem;margin-bottom:4px">Bessie</div>
              <div class="muted small" id="profile-tag">Tag QR-011</div>
            </div>
            <div class="avatar" id="profile-avatar">
              <i class="ri-cow-line"></i>
            </div>
          </div>

          <div class="profile-stats">
            <div style="flex:1">
              <div class="muted small">
                <i class="ri-weight-line"></i> Weight
              </div>
              <div id="profile-weight" style="font-weight:600;margin-top:4px">Normal</div>
            </div>
            <div style="flex:1">
              <div class="muted small">
                <i class="ri-restaurant-line"></i> Last Feed
              </div>
              <div id="profile-lastfeed" style="font-weight:600;margin-top:4px">2h ago</div>
            </div>
            <div style="flex:1">
              <div class="muted small">
                <i class="ri-heart-line"></i> Health
              </div>
              <div id="profile-health" style="font-weight:600;margin-top:4px" class="status-healthy">Good</div>
            </div>
          </div>

          <div class="mt8">
            <button class="big-btn" id="profile-scan">
              <i class="ri-camera-line"></i> Scan
            </button>
            <button class="big-btn" id="profile-history">
              <i class="ri-history-line"></i> View Health History
            </button>
          </div>
        </section>

        <section class="card">
          <div class="section-title" style="margin-bottom:12px">
            <i class="ri-alarm-warning-line"></i> Health Alerts
          </div>
          <div id="profile-alerts"></div>
        </section>

        <div style="margin-top:12px">
          <button class="btn-ghost" id="back-to-dashboard">
            <i class="ri-arrow-left-line"></i> Back to Dashboard
          </button>
        </div>
      </div>

      <!-- ALERTS VIEW -->
      <div id="view-alerts" class="view">
        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-alarm-warning-line"></i> All Alerts
            </div>
            <div class="chip" id="alerts-count">0</div>
          </div>
          <div id="alerts-all"></div>
        </section>
        <div style="margin-top:12px">
          <button class="btn-ghost" id="alerts-back">
            <i class="ri-arrow-left-line"></i> Back to Dashboard
          </button>
        </div>
      </div>

      <!-- SECURITY CENTER VIEW -->
      <div id="view-security" class="view">
        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-shield-keyhole-line"></i> Security Center
            </div>
            <div class="muted small">System integrity checks</div>
          </div>
          <div style="padding:12px 0;border-bottom:1px solid var(--border)">
            <div style="font-weight:600;margin-bottom:4px">
              <i class="ri-qr-code-line"></i> Tag validation
            </div>
            <div id="sec-tag" class="muted small">—</div>
          </div>
          <div style="padding:12px 0;border-bottom:1px solid var(--border)">
            <div style="font-weight:600;margin-bottom:4px">
              <i class="ri-radar-line"></i> Sensor integrity
            </div>
            <div id="sec-integrity" class="muted small">—</div>
          </div>
          <div style="padding:12px 0">
            <div style="font-weight:600;margin-bottom:4px">
              <i class="ri-music-2-line"></i> Audio replay detection
            </div>
            <div id="sec-replay" class="muted small">—</div>
          </div>
        </section>
        <div style="margin-top:12px">
          <button class="btn-ghost" id="sec-back">
            <i class="ri-arrow-left-line"></i> Back to Dashboard
          </button>
        </div>
      </div>
    </main>

    <!-- FOOTER NAV -->
    <footer class="app-footer">
      <button class="nav-btn active" data-view="dashboard" id="nav-dashboard">
        <i class="ri-home-4-line nav-icon"></i>
      </button>
      <button class="nav-btn" data-view="animals" id="nav-animals">
        <img src="/cow.png" width="20" alt="">
      </button>
      <button class="nav-btn" data-view="alerts" id="nav-alerts">
        <i class="ri-alarm-warning-line nav-icon"></i>
      </button>
      <button class="nav-btn" data-view="security" id="nav-security">
        <i class="ri-shield-keyhole-line nav-icon"></i>
      </button>
    </footer>
  </div>

  <!-- CAMERA MODAL -->
  <div id="modal-camera" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <div class="section-header" style="margin-bottom:16px">
        <strong style="font-size:1.1rem">
          <i class="ri-camera-line"></i> Scan Cattle
        </strong>
        <button class="btn-ghost" id="modal-camera-close">
          <i class="ri-close-line"></i> Close
        </button>
      </div>
      
      <div class="center">
        <video id="camera-video" autoplay playsinline></video>
        <img id="camera-preview" alt="Preview">
        
        <div class="muted small mb8" id="camera-instruction">
          Position cattle in frame and capture or upload a photo
        </div>
        
        <input type="file" accept="image/*" id="camera-file-input">
        
        <div class="camera-actions">
          <button class="btn-ghost" id="camera-use-file">
            <i class="ri-folder-upload-line"></i> Upload
          </button>
          <button class="big-btn" id="camera-snap">
            <i class="ri-camera-line"></i> Capture Photo
          </button>
        </div>
        
        <div class="progress"><i id="scan-progress"></i></div>
        
        <div class="muted small mt8" id="scan-status">
          Ready to scan
        </div>
      </div>
    </div>
  </div>

  <!-- SCAN RESULTS MODAL -->
  <div id="modal-results" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <div class="scan-results-header">
        <div class="scan-results-title">
          <i class="ri-search-eye-line"></i> Scan Results
        </div>
        <button class="btn-ghost" id="modal-results-close" style="padding: 8px 12px;">
          <i class="ri-close-line"></i> Close
        </button>
      </div>
      
      <div id="scan-results-content">
        <!-- Results will be populated here -->
      </div>
      
      <div class="scan-result-actions">
        <button class="btn-ghost" id="results-scan-other">
          <i class="ri-camera-line"></i> Scan Another
        </button>
        <button class="big-btn" id="results-view-profile">
          <i class="ri-cow-line"></i> View Cattle Profile
        </button>
      </div>
    </div>
  </div>

<script>
/* ===================
   Firebase Configuration
   =================== */
const firebaseConfig = {
  apiKey: "AIzaSyDr6z8B_p9sa_QBnKsthU8KfciRAfq5_ks",
  authDomain: "moombo-fafa8.firebaseapp.com",
  projectId: "moombo-fafa8",
  storageBucket: "moombo-fafa8.firebasestorage.app",
  messagingSenderId: "36732460150",
  appId: "1:36732460150:web:b64cb2e79d367386579357"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// Firebase Auth Providers
const googleProvider = new firebase.auth.GoogleAuthProvider();

/* ===================
   Toast Notification System
   =================== */
function showToast(message, type = 'info', duration = 3000) {
  const toast = el('#toast');
  toast.textContent = message;
  toast.className = 'toast';
  toast.classList.add(type);
  
  // Show toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);
  
  // Hide after duration
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.className = 'toast';
    }, 300);
  }, duration);
}

/* ===================
   Temporary MVP JSON - Cattle Focused
   =================== */
const SAMPLE_DATA = {
  animals: [
    {
      id: "cow-11",
      name: "Bessie",
      species: "Holstein",
      tag: "QR-011",
      weight_score: "Normal",
      last_feed: "2025-12-08T14:20:00Z",
      health_status: "Good",
      icon: "ri-cow-line",
      alerts: []
    },
    {
      id: "cow-12",
      name: "Daisy",
      species: "Jersey",
      tag: "QR-012",
      weight_score: "Low",
      last_feed: "2025-12-08T10:00:00Z",
      health_status: "Warning",
      icon: "ri-cow-line",
      alerts: [
        { id: "a001", type: "Distress sound", severity: "High", timestamp: "2025-12-08T18:12:00Z", message: "Repeated distress calls" }
      ]
    },
    {
      id: "cow-13",
      name: "Molly",
      species: "Angus",
      tag: "QR-013",
      weight_score: "Normal",
      last_feed: "2025-12-08T15:00:00Z",
      health_status: "Good",
      icon: "ri-cow-line",
      alerts: []
    },
    {
      id: "cow-14",
      name: "Clara",
      species: "Hereford",
      tag: "QR-014",
      weight_score: "High",
      last_feed: "2025-12-08T12:30:00Z",
      health_status: "Warning",
      icon: "ri-cow-line",
      alerts: [
        { id: "a002", type: "Weight alert", severity: "Medium", timestamp: "2025-12-08T16:45:00Z", message: "Weight above normal range" }
      ]
    }
  ],
  alerts: [
    { alert_id: "a001", animal_id: "cow-12", type: "Distress sound", severity: "High", timestamp: "2025-12-08T18:12:00Z" },
    { alert_id: "a002", animal_id: "cow-14", type: "Weight alert", severity: "Medium", timestamp: "2025-12-08T16:45:00Z" }
  ],
  user: null
}

/* ============
   Storage helpers with user-specific data
   ============ */
function loadState(userId){
  const key = `lam_mvp_v3_${userId || 'demo'}`;
  const raw = localStorage.getItem(key);
  if (!raw){
    localStorage.setItem(key, JSON.stringify(SAMPLE_DATA));
    return JSON.parse(JSON.stringify(SAMPLE_DATA));
  }
  try { 
    return JSON.parse(raw); 
  } catch(e){ 
    localStorage.setItem(key, JSON.stringify(SAMPLE_DATA)); 
    return JSON.parse(JSON.stringify(SAMPLE_DATA)); 
  }
}

function saveState(state, userId){
  const key = `lam_mvp_v3_${userId || 'demo'}`;
  localStorage.setItem(key, JSON.stringify(state));
}

let STATE = null;
let currentUser = null;

/* ====================
   Global variables for scan results
   ==================== */
let lastScanResult = null;
let lastScannedAnimal = null;

/* ====================
   Utilities & helpers
   ==================== */
function el(q, ctx=document) { return ctx.querySelector(q); }
function els(q, ctx=document) { return Array.from(ctx.querySelectorAll(q)); }
function fmtTime(iso){ try{ const d=new Date(iso); return d.toLocaleString(); }catch(e){return iso;} }
function relativeTime(iso){
  const d=new Date(iso), now=new Date(); const diff=(now-d)/1000; if (diff<60) return Math.round(diff)+'s ago'; if (diff<3600) return Math.round(diff/60)+'m ago'; if (diff<86400) return Math.round(diff/3600)+'h ago'; return Math.round(diff/86400)+'d ago';
}

/* ====================
   Application Flow Control
   ==================== */
function initApp() {
  // Show splash screen first
  const splash = el('#splash-screen');
  splash.classList.remove('hidden');
  
  // After 1.5 seconds, initialize Firebase Auth and check user
  setTimeout(() => {
    splash.style.opacity = '0';
    
    setTimeout(() => {
      splash.classList.add('hidden');
      
      // Check Firebase auth state
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed in
          handleUserSignedIn(user);
        } else {
          // No user is signed in
          showAuthScreen('login');
        }
      });
    }, 500);
  }, 1500);
}

function handleUserSignedIn(user) {
  currentUser = {
    uid: user.uid,
    email: user.email,
    displayName: user.displayName || user.email.split('@')[0],
    photoURL: user.photoURL,
    loginTime: new Date().toISOString()
  };
  
  // Load user-specific data
  STATE = loadState(user.uid);
  STATE.user = currentUser;
  
  showMainApp();
}

function showAuthScreen(screen) {
  const authScreen = el('#auth-screen');
  const app = el('#app');
  
  authScreen.classList.remove('hidden');
  app.classList.add('hidden');
  
  // Show the requested auth screen
  els('.auth-view').forEach(view => view.classList.add('hidden'));
  if (screen === 'login') {
    el('#auth-login').classList.remove('hidden');
  } else if (screen === 'signup') {
    el('#auth-signup').classList.remove('hidden');
  } else if (screen === 'forgot') {
    el('#auth-forgot').classList.remove('hidden');
  }
}

function showMainApp() {
  const authScreen = el('#auth-screen');
  const app = el('#app');
  
  authScreen.classList.add('hidden');
  app.classList.remove('hidden');
  
  // Initialize the app UI
  setTimeout(() => {
    app.classList.add('app-loaded');
    boot();
  }, 100);
}

/* ====================
   Firebase Authentication Handlers
   ==================== */
// Email/Password Sign In
el('#btn-login').addEventListener('click', async function() {
  const email = el('#login-email').value.trim();
  const password = el('#login-password').value.trim();
  
  if (!email || !password) {
    showToast('Please enter both email and password', 'error');
    return;
  }
  
  try {
    showToast('Signing in...', 'info');
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    showToast('Welcome back!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Login error:', error);
    let message = 'Login failed. ';
    switch(error.code) {
      case 'auth/invalid-email':
        message += 'Invalid email address.';
        break;
      case 'auth/user-disabled':
        message += 'This account has been disabled.';
        break;
      case 'auth/user-not-found':
        message += 'No account found with this email.';
        break;
      case 'auth/wrong-password':
        message += 'Incorrect password.';
        break;
      default:
        message += error.message;
    }
    showToast(message, 'error');
  }
});

// Email/Password Sign Up
el('#btn-signup').addEventListener('click', async function() {
  const name = el('#signup-name').value.trim();
  const email = el('#signup-email').value.trim();
  const password = el('#signup-password').value.trim();
  const confirm = el('#signup-confirm').value.trim();
  
  if (!name || !email || !password || !confirm) {
    showToast('Please fill all fields', 'error');
    return;
  }
  
  if (password !== confirm) {
    showToast('Passwords do not match', 'error');
    return;
  }
  
  if (password.length < 6) {
    showToast('Password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    showToast('Creating account...', 'info');
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    
    // Update display name
    await userCredential.user.updateProfile({
      displayName: name
    });
    
    showToast('Account created successfully!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Signup error:', error);
    let message = 'Signup failed. ';
    switch(error.code) {
      case 'auth/email-already-in-use':
        message += 'Email already in use.';
        break;
      case 'auth/invalid-email':
        message += 'Invalid email address.';
        break;
      case 'auth/operation-not-allowed':
        message += 'Email/password accounts are not enabled.';
        break;
      case 'auth/weak-password':
        message += 'Password is too weak.';
        break;
      default:
        message += error.message;
    }
    showToast(message, 'error');
  }
});

// Google Sign In/Sign Up
el('#btn-google-login').addEventListener('click', async function() {
  try {
    showToast('Connecting with Google...', 'info');
    const result = await auth.signInWithPopup(googleProvider);
    showToast('Signed in with Google!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Google auth error:', error);
    showToast('Google sign-in failed: ' + error.message, 'error');
  }
});

el('#btn-google-signup').addEventListener('click', async function() {
  try {
    showToast('Connecting with Google...', 'info');
    const result = await auth.signInWithPopup(googleProvider);
    showToast('Account created with Google!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Google auth error:', error);
    showToast('Google sign-in failed: ' + error.message, 'error');
  }
});

// Forgot Password
el('#btn-forgot-password').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('forgot');
});

el('#btn-send-reset').addEventListener('click', async function() {
  const email = el('#forgot-email').value.trim();
  
  if (!email) {
    showToast('Please enter your email', 'error');
    return;
  }
  
  try {
    showToast('Sending reset email...', 'info');
    await auth.sendPasswordResetEmail(email);
    showToast('Password reset email sent! Check your inbox.', 'success');
    
    // Go back to login after 2 seconds
    setTimeout(() => {
      showAuthScreen('login');
    }, 2000);
  } catch (error) {
    console.error('Password reset error:', error);
    let message = 'Failed to send reset email. ';
    switch(error.code) {
      case 'auth/invalid-email':
        message += 'Invalid email address.';
        break;
      case 'auth/user-not-found':
        message += 'No account found with this email.';
        break;
      default:
        message += error.message;
    }
    showToast(message, 'error');
  }
});

// Logout
el('#btn-logout').addEventListener('click', async function() {
  if (confirm('Are you sure you want to logout?')) {
    try {
      await auth.signOut();
      currentUser = null;
      STATE = null;
      showToast('Signed out successfully', 'success');
      showAuthScreen('login');
    } catch (error) {
      console.error('Logout error:', error);
      showToast('Logout failed: ' + error.message, 'error');
    }
  }
});

// Navigation between auth screens
el('#btn-go-to-signup').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('signup');
});

el('#btn-go-to-login').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('login');
});

el('#btn-go-to-login-from-forgot').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('login');
});

/* ====================
   UI rendering
   ==================== */
function renderStats(){
  if (!STATE) return;
  const animals = STATE.animals.length;
  const healthy = STATE.animals.filter(a=>a.health_status==='Good').length;
  const sick = STATE.animals.filter(a=>a.health_status!=='Good').length;
  
  el('#stat-animals').textContent = animals;
  el('#stat-healthy').textContent = healthy;
  el('#stat-sick').textContent = sick;
}

/* Render animals list on dashboard */
function renderAnimalsList(){
  if (!STATE) return;
  const container = el('#animals-list'); container.innerHTML='';
  STATE.animals.forEach(a=>{
    const div=document.createElement('div'); div.className='animal-card';
    div.dataset.id=a.id;
    div.innerHTML = `
      <div class="avatar"><i class="${a.icon || 'ri-cow-line'}"></i></div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong style="font-size:1rem">${a.name}</strong><div class="muted small" style="margin-top:2px">${a.species} • ${a.tag}</div></div>
          <div style="text-align:right"><div class="${a.health_status==='Good'?'status-healthy':(a.health_status==='Warning'?'status-warn':'status-critical')}">${a.health_status}</div><div class="muted small" style="margin-top:2px">${a.weight_score}</div></div>
        </div>
      </div>
    `;
    div.addEventListener('click', ()=>openProfile(a.id));
    container.appendChild(div);
  });
}

/* Render alerts preview */
function renderAlertsPreview(){
  if (!STATE) return;
  const list = el('#alerts-list'); list.innerHTML='';
  const recent = STATE.alerts.slice().sort((x,y)=>new Date(y.timestamp)-new Date(x.timestamp)).slice(0,3);
  if (recent.length===0){ list.innerHTML='<div class="muted small" style="text-align:center;padding:20px">No alerts at the moment</div>'; return; }
  recent.forEach(a=>{
    const animal = STATE.animals.find(x=>x.id===a.animal_id);
    const div=document.createElement('div'); div.className='alert-row';
    div.innerHTML = `<div class="avatar" style="width:44px;height:44px;font-size:1.2rem;background:${a.severity==='High'?'var(--danger)':a.severity==='Medium'?'var(--warn)':'var(--good)'}"><i class="${animal?animal.icon:'ri-alarm-warning-line'}"></i></div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px;color:${a.severity==='High'?'var(--danger)':a.severity==='Medium'?'var(--warn)':'var(--good)'}">${animal?animal.name:'Unknown'}</div>
        <div class="muted small">${a.type} • ${relativeTime(a.timestamp)}</div>
      </div>
      <div><button class="btn-ghost" data-id="${a.alert_id}" style="padding:6px 12px;font-size:0.8rem;">
        <i class="ri-eye-line"></i> View
      </button></div>`;
    div.querySelector('button').addEventListener('click', ()=>openProfile(a.animal_id));
    list.appendChild(div);
  });
}

/* Render full alerts page */
function renderAllAlerts(){
  if (!STATE) return;
  el('#alerts-all').innerHTML='';
  const all = STATE.alerts.slice().sort((x,y)=>new Date(y.timestamp)-new Date(x.timestamp));
  el('#alerts-count').textContent = all.length;
  if (all.length===0){ el('#alerts-all').innerHTML='<div class="muted small" style="text-align:center;padding:30px">No alerts in the system</div>'; return; }
  all.forEach(a=>{
    const animal = STATE.animals.find(x=>x.id===a.animal_id);
    const div=document.createElement('div'); div.className='alert-row';
    div.innerHTML = `<div class="avatar" style="width:44px;height:44px;font-size:1.2rem;background:${a.severity==='High'?'var(--danger)':a.severity==='Medium'?'var(--warn)':'var(--good)'}"><i class="${animal?animal.icon:'ri-alarm-warning-line'}"></i></div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">${animal?animal.name:'Unknown'}</div>
        <div class="muted small">${a.type} • ${fmtTime(a.timestamp)}</div>
      </div>
      <div><button class="btn-ghost" data-id="${a.alert_id}" style="padding:6px 12px;font-size:0.8rem;">
        <i class="ri-external-link-line"></i> Open
      </button></div>`;
    div.querySelector('button').addEventListener('click', ()=>openProfile(a.animal_id));
    el('#alerts-all').appendChild(div);
  });
}

/* Profile render */
function openProfile(animalId){
  if (!STATE) return;
  const animal = STATE.animals.find(a=>a.id===animalId);
  if (!animal) return showToast('Animal not found', 'error');
  // populate
  el('#profile-name').textContent = animal.name;
  el('#profile-tag').textContent = animal.tag;
  el('#profile-avatar').innerHTML = `<i class="${animal.icon || 'ri-cow-line'}"></i>`;
  el('#profile-weight').textContent = animal.weight_score;
  el('#profile-lastfeed').textContent = relativeTime(animal.last_feed);
  el('#profile-health').textContent = animal.health_status;
  el('#profile-health').className = animal.health_status==='Good' ? 'status-healthy' : (animal.health_status==='Warning' ? 'status-warn' : 'status-critical');
  // alerts for the animal
  const pa = el('#profile-alerts'); pa.innerHTML='';
  const alerts = STATE.alerts.filter(x=>x.animal_id===animalId).sort((x,y)=>new Date(y.timestamp)-new Date(x.timestamp));
  if (alerts.length===0) pa.innerHTML='<div class="muted small" style="text-align:center;padding:20px">No alerts for this cattle</div>';
  alerts.forEach(al=>{
    const d=document.createElement('div'); d.className='alert-row';
    d.innerHTML = `<div class="avatar" style="width:44px;height:44px;font-size:1.2rem;background:${al.severity==='High'?'var(--danger)':al.severity==='Medium'?'var(--warn)':'var(--good)'}"><i class="${animal.icon || 'ri-cow-line'}"></i></div>
      <div style="flex:1"><div style="font-weight:600;margin-bottom:2px">${al.type}</div><div class="muted small">${fmtTime(al.timestamp)}</div></div>
      <div><span class="${al.severity==='High'?'status-critical':(al.severity==='Medium'?'status-warn':'status-healthy')}">${al.severity}</span></div>`;
    pa.appendChild(d);
  });

  // switch views
  showView('profile');
  // attach profile-specific actions
  el('#profile-scan').onclick = ()=>openCameraModal('scan', animal.id);
  el('#profile-history').onclick = ()=>alert('Health history would show past weight measurements, feed times, and health events for this cattle.');
}

/* Navigation: show specific view */
function showView(view){
  // hide all views
  els('.view').forEach(v=>v.classList.remove('active'));
  // show requested view
  el(`#view-${view}`).classList.add('active');
  
  // update footer nav
  els('.nav-btn').forEach(b=>b.classList.remove('active'));
  el(`#nav-${view}`).classList.add('active');
}

/* Render security center (mock checks) */
function renderSecurity(){
  // simple simulated checks
  const tag = { tag_valid: true, tag_type: "NFC", integrity: "OK" };
  const integrity = { data_tampering_detected: false };
  const replay = { audio_fingerprint: "unique-123", replay_attack: false };
  el('#sec-tag').textContent = `Tag valid: ${tag.tag_valid} • type: ${tag.tag_type}`;
  el('#sec-integrity').textContent = `Tampering: ${integrity.data_tampering_detected ? 'DETECTED' : 'OK'}`;
  el('#sec-replay').textContent = `Replay attack: ${replay.replay_attack ? 'YES' : 'NO'}`;
}

/* Boot & render everything */
function boot(){
  if (!STATE || !currentUser) {
    showAuthScreen('login');
    return;
  }
  
  renderStats();
  renderAnimalsList();
  renderAlertsPreview();
  renderAllAlerts();
  renderSecurity();
  showView('dashboard');
}

/* ==========================
   Simple Mock AI processors
   ========================== */

/* Mock vision AI: analyze photo and return object */
function mockVisionAIAnalyze(imageBlob){
  // This is a mock. In real app you'd send image to an ML model or run on-device inference.
  // We'll randomly decide presence of wound or weight issues to demonstrate flow.
  const rnd = Math.random();
  
  // Random breed selection
  const breeds = ["Holstein", "Jersey", "Angus", "Hereford", "Brahman", "Simmental"];
  const randomBreed = breeds[Math.floor(Math.random() * breeds.length)];
  
  // Random weight between 350-550 kg
  const randomWeight = Math.floor(Math.random() * 200) + 350;
  
  if (rnd < 0.15) {
    return { 
      wound_detected: true, 
      wound_location: "hind leg", 
      weight_score: "Low", 
      confidence: (Math.random() * 0.2 + 0.8).toFixed(2),
      breed_detected: randomBreed,
      estimated_weight: `${randomWeight} kg`,
      overall_health: "Critical",
      temperature_estimated: "39.2°C",
      hydration_level: "Low",
      movement_score: "Restricted"
    };
  } else if (rnd < 0.35) {
    return { 
      wound_detected: false, 
      wound_location: null, 
      weight_score: "Low", 
      confidence: (Math.random() * 0.2 + 0.7).toFixed(2),
      breed_detected: randomBreed,
      estimated_weight: `${randomWeight} kg`,
      overall_health: "Warning",
      temperature_estimated: "38.8°C",
      hydration_level: "Adequate",
      movement_score: "Normal"
    };
  } else if (rnd < 0.5) {
    return { 
      wound_detected: false, 
      wound_location: null, 
      weight_score: "High", 
      confidence: (Math.random() * 0.2 + 0.8).toFixed(2),
      breed_detected: randomBreed,
      estimated_weight: `${randomWeight} kg`,
      overall_health: "Warning",
      temperature_estimated: "38.5°C",
      hydration_level: "Good",
      movement_score: "Active"
    };
  } else {
    return { 
      wound_detected: false, 
      wound_location: null, 
      weight_score: "Normal", 
      confidence: (Math.random() * 0.2 + 0.85).toFixed(2),
      breed_detected: randomBreed,
      estimated_weight: `${randomWeight} kg`,
      overall_health: "Good",
      temperature_estimated: "38.5°C",
      hydration_level: "Good",
      movement_score: "Active"
    };
  }
}

/* ===============================
   Enhanced Camera modal with scanning
   =============================== */
let cameraStream = null;
let currentCameraTargetId = null; // animal id when triggered from profile
let scanInProgress = false;

async function openCameraModal(mode='scan', targetId=null){
  currentCameraTargetId = targetId;
  el('#modal-camera').classList.remove('hidden');
  el('#modal-camera').ariaHidden = 'false';
  el('#camera-preview').style.display = 'none';
  el('#camera-video').style.display = 'block';
  el('#scan-status').textContent = 'Position cattle in frame';
  el('#scan-progress').style.width = '0%';
  scanInProgress = false;
  
  // Reset file input
  el('#camera-file-input').value = '';
  
  // start camera if available
  const video = el('#camera-video');
  try{
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }, 
      audio: false
    });
    video.srcObject = cameraStream;
    video.play();
    el('#camera-instruction').textContent = 'Position cattle in frame and capture or upload a photo';
  }catch(e){
    video.srcObject = null;
    console.warn('Camera not available, use file upload fallback', e);
    el('#camera-instruction').textContent = 'Camera not available. Please upload a photo instead.';
    el('#camera-snap').disabled = true;
    el('#camera-snap').innerHTML = '<i class="ri-camera-off-line"></i> Camera Unavailable';
  }
}

/* Close camera modal */
function closeCameraModal(){
  el('#modal-camera').classList.add('hidden');
  el('#modal-camera').ariaHidden = 'true';
  // stop stream
  if (cameraStream) {
    cameraStream.getTracks().forEach(t=>t.stop());
    cameraStream = null;
  }
  scanInProgress = false;
}

/* Snapshot from video */
async function captureFromVideo(){
  if (scanInProgress) return null;
  
  const video = el('#camera-video');
  if (!video || video.readyState < 2) {
    alert('Camera not ready. You can upload a photo instead.');
    return null;
  }
  
  // Show preview
  const canvas = document.createElement('canvas'); 
  canvas.width = video.videoWidth; 
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d'); 
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // Show the captured image
  el('#camera-preview').src = canvas.toDataURL('image/jpeg');
  el('#camera-preview').style.display = 'block';
  el('#camera-video').style.display = 'none';
  
  return await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
}

/* File upload fallback */
el('#camera-use-file').onclick = ()=>el('#camera-file-input').click();

el('#camera-file-input').onchange = async (ev)=>{
  const file = ev.target.files[0]; 
  if (!file) return;
  
  // Validate file type
  if (!file.type.match('image.*')) {
    alert('Please select an image file (JPEG, PNG, etc.)');
    return;
  }
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    el('#camera-preview').src = e.target.result;
    el('#camera-preview').style.display = 'block';
    el('#camera-video').style.display = 'none';
    el('#scan-status').textContent = 'Photo ready for analysis';
  };
  reader.readAsDataURL(file);
  
  // Process the file
  await processCapturedPhoto(file);
};

/* When user presses capture */
el('#camera-snap').onclick = async ()=>{
  if (scanInProgress) return;
  
  el('#scan-status').textContent = 'Capturing photo...';
  const blob = await captureFromVideo();
  if (blob) {
    await processCapturedPhoto(blob);
  }
};

/* Show scan results modal */
function showScanResults(result, matchedAnimal){
  // Store results globally for later use
  lastScanResult = result;
  lastScannedAnimal = matchedAnimal;
  
  // Determine health status color
  let healthStatusClass = 'scan-result-good';
  let healthStatusText = 'Good';
  let healthStatusIndicator = 'good';
  
  if (result.overall_health === 'Critical') {
    healthStatusClass = 'scan-result-danger';
    healthStatusText = 'Critical';
    healthStatusIndicator = 'danger';
  } else if (result.overall_health === 'Warning') {
    healthStatusClass = 'scan-result-warning';
    healthStatusText = 'Warning';
    healthStatusIndicator = 'warning';
  }
  
  // Determine weight status color
  let weightStatusClass = 'scan-result-good';
  if (result.weight_score === 'Low') weightStatusClass = 'scan-result-warning';
  if (result.weight_score === 'High') weightStatusClass = 'scan-result-warning';
  
  // Build results HTML
  let resultsHTML = '';
  
  // If we matched an existing animal
  if (matchedAnimal) {
    resultsHTML += `
      <div class="animal-match">
        <div class="avatar" style="width:60px;height:60px;">
          <i class="${matchedAnimal.icon || 'ri-cow-line'}"></i>
        </div>
        <div class="animal-match-info">
          <div class="animal-match-name">${matchedAnimal.name}</div>
          <div class="muted small">${matchedAnimal.species} • ${matchedAnimal.tag}</div>
          <div class="match-confidence">Match confidence: ${(result.confidence * 100).toFixed(1)}%</div>
        </div>
      </div>
    `;
  } else {
    resultsHTML += `
      <div class="animal-match">
        <div class="avatar" style="width:60px;height:60px;">
          <i class="ri-cow-line"></i>
        </div>
        <div class="animal-match-info">
          <div class="animal-match-name">New Cattle Detected</div>
          <div class="muted small">Not in your database</div>
          <div class="match-confidence">Detection confidence: ${(result.confidence * 100).toFixed(1)}%</div>
        </div>
      </div>
    `;
  }
  
  // Add scan details
  resultsHTML += `
    <div style="margin: 20px 0;">
      <div class="scan-result-item">
        <div class="scan-result-label">Overall Health</div>
        <div class="scan-result-value">
          <span class="status-indicator ${healthStatusIndicator}">
            <i class="ri-heart-line"></i> ${healthStatusText}
          </span>
        </div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Weight Status</div>
        <div class="scan-result-value ${weightStatusClass}">
          ${result.weight_score} (${result.estimated_weight})
        </div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Breed Detected</div>
        <div class="scan-result-value">${result.breed_detected}</div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Estimated Temp</div>
        <div class="scan-result-value">${result.temperature_estimated}</div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Hydration Level</div>
        <div class="scan-result-value">${result.hydration_level}</div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Movement Score</div>
        <div class="scan-result-value">${result.movement_score}</div>
      </div>
  `;
  
  // Add wound detection if present
  if (result.wound_detected) {
    resultsHTML += `
      <div class="scan-result-item">
        <div class="scan-result-label">Wound Detected</div>
        <div class="scan-result-value scan-result-danger">
          <i class="ri-alert-line"></i> ${result.wound_location}
        </div>
      </div>
    `;
  }
  
  resultsHTML += `</div>`;
  
  // Update results content
  el('#scan-results-content').innerHTML = resultsHTML;
  
  // Show the results modal
  el('#modal-results').classList.remove('hidden');
  el('#modal-results').ariaHidden = 'false';
}

/* Close scan results modal */
function closeScanResults(){
  el('#modal-results').classList.add('hidden');
  el('#modal-results').ariaHidden = 'true';
  lastScanResult = null;
  lastScannedAnimal = null;
}

/* Process photo result with scanning animation */
async function processCapturedPhoto(blob){
  if (scanInProgress) return;
  scanInProgress = true;
  
  el('#scan-status').textContent = 'Analyzing image...';
  
  // Simulate scanning progress
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 10;
    el('#scan-progress').style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(progressInterval);
    }
  }, 100);
  
  // Run mock vision AI after a short delay
  setTimeout(async () => {
    // Run mock vision AI
    const result = mockVisionAIAnalyze(blob);
    
    clearInterval(progressInterval);
    el('#scan-progress').style.width = '100%';
    el('#scan-status').textContent = 'Analysis complete!';
    
    // If called from profile -> update animal
    if (currentCameraTargetId){
      const animal = STATE.animals.find(a=>a.id===currentCameraTargetId);
      if (!animal) { 
        showToast('Animal missing', 'error'); 
        closeCameraModal(); 
        scanInProgress = false;
        return; 
      }
      
      // Update animal data
      animal.weight_score = result.weight_score;
      animal.health_status = result.overall_health === 'Critical' ? 'Critical' : 
                             (result.overall_health === 'Warning' ? 'Warning' : 'Good');
      
      // create alert if problem
      if (result.wound_detected || result.weight_score!=='Normal'){
        const alertId = 'a'+Math.floor(Math.random()*1000000);
        const severity = result.wound_detected ? 'High' : (result.weight_score==='Low' ? 'Medium' : 'Low');
        const newAlert = { 
          alert_id: alertId, 
          animal_id: animal.id, 
          type: result.wound_detected ? 'Wound detected' : `${result.weight_score} weight`, 
          severity, 
          timestamp: (new Date()).toISOString(),
          message: result.wound_detected ? 
            `Wound detected on ${result.wound_location}` : 
            `Weight: ${result.estimated_weight} (${result.weight_score})`
        };
        STATE.alerts.push(newAlert);
        animal.alerts = animal.alerts || []; 
        animal.alerts.push(newAlert);
        
        // Save state
        saveState(STATE, currentUser.uid);
      }
      
      renderAllAlerts(); 
      renderAlertsPreview(); 
      renderAnimalsList(); 
      renderStats();
      
      // Show results modal
      setTimeout(() => {
        closeCameraModal();
        showScanResults(result, animal);
      }, 500);
      
    } else {
      // If scanning from dashboard, simulate tag/face recognition:
      // 30% chance to detect as new cattle, 70% chance to match existing
      let matchedAnimal = null;
      if (Math.random() < 0.7) {
        matchedAnimal = STATE.animals[Math.floor(Math.random() * STATE.animals.length)];
      }
      
      // Show results modal
      setTimeout(() => {
        closeCameraModal();
        showScanResults(result, matchedAnimal);
      }, 500);
    }
    
    scanInProgress = false;
  }, 2000);
}

/* Open camera modal utility */
el('#btn-scan-top').onclick = ()=>openCameraModal('scan', null);
el('#modal-camera-close').onclick = ()=>closeCameraModal();

/* Scan results modal handlers */
el('#modal-results-close').onclick = closeScanResults;

el('#results-scan-other').onclick = function() {
  closeScanResults();
  setTimeout(() => {
    openCameraModal('scan', null);
  }, 300);
};

el('#results-view-profile').onclick = function() {
  if (lastScannedAnimal) {
    closeScanResults();
    setTimeout(() => {
      openProfile(lastScannedAnimal.id);
    }, 300);
  } else {
    showToast('This cattle is not in your database. You can add it from the dashboard.', 'info');
    closeScanResults();
  }
};

/* =====================
   Small UI bindings
   ===================== */
el('#back-to-dashboard').onclick = ()=>{ showView('dashboard'); }
el('#btn-open-alerts').onclick = ()=>{ showView('alerts'); }
el('#alerts-back').onclick = ()=>{ showView('dashboard'); }
el('#sec-back').onclick = ()=>{ showView('dashboard'); }

// Footer navigation
els('.nav-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const view = this.dataset.view;
    showView(view);
    if (view === 'security') renderSecurity();
  });
});

// Profile button in header
el('#btn-profile').addEventListener('click', function() {
  if (currentUser) {
    alert(`Profile Information:\n\nName: ${currentUser.displayName}\nEmail: ${currentUser.email}\n\nAccount management features would be implemented in a production version.`);
  } else {
    alert('User profile information not available.');
  }
});

el('#nav-animals').onclick = ()=>{ 
  showView('dashboard'); 
  // Scroll to animals section
  setTimeout(() => {
    const animalsSection = document.querySelector('#animals-list').closest('.card');
    animalsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

/* Security center demo toggle - simulate tampering detection every 10s */
setInterval(()=>{
  // small random flip to demo 'tampering detected' once in a while
  if (el('#view-security').classList.contains('active')) {
    const tamper = Math.random() < 0.05;
    el('#sec-integrity').textContent = `Tampering: ${tamper ? 'DETECTED' : 'OK'}`;
  }
}, 10000);

/* Ensure rendering refresh after state updates (useful while demoing) */
window.refreshUI = ()=>{
  if (!STATE) return;
  renderStats(); renderAnimalsList(); renderAlertsPreview(); renderAllAlerts();
};

/* Immediately expose STATE for debugging in dev console */
window._LAM_STATE = STATE;

/* =====================
   Initialize App
   ===================== */
document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>